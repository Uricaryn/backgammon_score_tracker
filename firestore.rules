rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Kullanıcılar sadece kendi verilerini okuyabilir
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Premium durumu sadece server tarafından değiştirilebilir
      allow update: if request.auth != null && 
        request.auth.uid == userId && 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isPremium', 'premiumExpiryDate', 'premiumDays', 'purchaseVerified']);
    }
    
    // Satın alma geçmişi sadece okunabilir
    match /purchase_history/{purchaseId} {
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow write: if false; // Sadece server yazabilir
    }
    
    // Diğer koleksiyonlar için güvenlik
    match /matches/{matchId} {
      allow read, write: if request.auth != null && 
        (resource.data.player1 == request.auth.uid || 
         resource.data.player2 == request.auth.uid);
    }
    
    match /tournaments/{tournamentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        resource.data.createdBy == request.auth.uid;
    }
    
    match /friends/{friendshipId} {
      allow read, write: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         resource.data.friendId == request.auth.uid);
    }
    
    // Premium özellikler için kontrol
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
} 